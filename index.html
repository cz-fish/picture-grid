<html>
    <head>
        <title>Picture Grid</title>
        <style>

#drop_zone {
    border: 1px solid black;
    width: 100%;
    height: 95%;
    margin-top: 30px;
    background-color: beige;
    text-align: center;
    font-size: 2em;
}

#drop_zone.highlight {
    border-color: pink;
}

.pictures {
    width: 100%;
    margin-top: 50px;
    display: none;
}

.pictures div {
    max-width: 40%;
    display: inline;
}

#gs_picture img {
    filter: saturate(0%);
    margin-left: 5%;
}

#grid {
    position: relative;
}

.grid_pic {
    position: absolute;
    width: 40%;
    z-index: -1;
    border: 1px solid black;
}

.gs_pic {
    position: absolute;
    width: 40%;
    border: 1px solid black;
}

p.reset {
    font-size: 2em;
    color: blue;
    text-align: center;
    cursor: pointer;
    text-decoration-line: underline;
}

        </style>
    </head>
    <body>
        <div class="controls" id="controls">
            <div id="drop_zone">
                <p>Drag and drop picture here</p>
                <p>Or</p>
                <p>Browse to select a picture</p>
                <form>
                    <input type="file" id="fileUpload" multiple accept="image/*" onchange="handleFiles(this.files);">
                </form>
            </div>
        </div>
        <div class="pictures" id="pictures">
            <div id="grid_picture"></div>
            <img src="grid.png" id="grid" />
            <div id="gs_picture"></div>
            <p id="image_info"></p>
            <p class="reset"><a onclick="newPicture()">New picture</a></p>
        </div>
        <script language="javascript">

const dropArea = document.getElementById("drop_zone");

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
});

['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, unhighlight, false);
});

dropArea.addEventListener('drop', handleDrop, false);

window.onresize = resizeGrid;

function highlight(e) {
    dropArea.classList.add('highlight');
}

function unhighlight(e) {
    dropArea.classList.remove('highlight');
}

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

let gridImg = undefined;

async function handleDrop(event)
{
    console.log("Handling file drop event");
    const data = event.dataTransfer;
    await handleFiles(data.files);
}

async function handleFiles(filelist)
{
    const files = [...filelist];
    if (files.length < 1) {
        console.log("No files dropped");
        return;
    }
    await openFile(files[0]);
}

async function openFile(file)
{
    document.getElementById("controls").style.display = "none";
    document.getElementById("pictures").style.display = "block";
    // convert to an img
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onloadend = async function() {
        gridImg = document.createElement('img');
        gridImg.onload = function() {
            // functions that require iamge to be completely loaded
            resizeGrid();
            updateImageInfo(gridImg);
        };
        gridImg.src = reader.result;
        gridImg.classList.add("grid_pic");
        gridImg.classList.add("show_pic");
        gridImg.id = "gridImg";
        const gsImg = document.createElement('img');
        gsImg.src = reader.result;
        gsImg.classList.add("gs_pic");
        gsImg.classList.add("show_pic");
        gsImg.id = "gsImg";
        document.getElementById('grid_picture').appendChild(gridImg);
        document.getElementById('gs_picture').appendChild(gsImg);
    };
}

function resizeGrid()
{
    if (!gridImg) {
        return;
    }
    const overlay = document.getElementById("grid");
    overlay.style.width = gridImg.clientWidth;
    overlay.style.height = gridImg.clientHeight;
}

function newPicture()
{
    [... document.getElementsByClassName("show_pic")].forEach(element => {
        element.parentElement.removeChild(element);
    });

    document.getElementById("controls").style.display = "block";
    document.getElementById("pictures").style.display = "none";
}

function gcd(x, y)
{
    if (x === 0) {
        return y;
    }
    return gcd(y % x, x);
}

function reduceFraction(x, y)
{
    const commonDivisor = gcd(x, y);
    return [x / commonDivisor, y / commonDivisor];
}

function updateImageInfo(element)
{
    // naturalWidth/Height - the original image dimensions before scaling to the browser size
    const width = element.naturalWidth;
    const height = element.naturalHeight;
    const ratio = reduceFraction(width, height);
    console.log(`image width ${width}, height ${height}, ratio ${ratio[0]}:${ratio[1]} (${width/height})`);
    document.getElementById("image_info").innerText = `Image aspect ratio ${ratio[0]}:${ratio[1]}`;
}

        </script>
    </body>
</html>